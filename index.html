<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">
    <head>
        <meta charset="utf-8" />
        <title>でんでんライブエディタ</title>
        <script type="text/javascript" src="http://denshoch.github.io/mojimate.js/mojimate.js"></script>
        <script type="text/javascript" src="https://www.dropbox.com/static/api/2/dropins.js" id="dropboxjs" data-app-key="p5gmil9rggf9wo1"></script>
        <link href="http://netdna.bootstrapcdn.com/bootstrap/3.1.0/css/bootstrap.min.css" rel="stylesheet" />
        <link href="assets/stylesheets/style.css" rel="stylesheet" />
        <link href="assets/stylesheets/non-responsive.css" rel="stylesheet" />
        <link rel="shortcut icon" href="assets/icons/favicon.ico" />
    </head>
    <body>
      <!-- Fixed navbar -->
      <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="container">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>

            <a class="navbar-brand" href="#"><i class="logo"></i> でんでんライブエディタ</a>
          </div>
          <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
              <li><a href="http://conv.denshochan.com/" target="_blank">でんでんコンバーター</a></li>
              <li><a href="http://conv.denshochan.com/markdown" target="_blank">でんでんマークダウン</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
        
        <div id="wrap">
         <div class="container">
            <!-- Nav tabs -->
            <ul class="nav nav-tabs">
                <li><a id="editor-link" href="#editor-tab" data-toggle="tab"><i class="glyphicon glyphicon-pencil"></i> Edit</a></li>
                <li><a id="preview-link" href="#preview-tab" data-toggle="tab"><i class="glyphicon glyphicon-eye-open"></i> Preview</a></li>
                <li><a id="code-link" href="#code-tab" data-toggle="tab"><i class="glyphicon glyphicon-list-alt"></i> Code</a></li>
                <li><a id="css-editor-link" href="#css-tab" data-toggle="tab"><i class="glyphicon glyphicon-asterisk"></i> Custom CSS</a></li>
                <li><a id="css-settings-link" href="#settings-tab" data-toggle="tab"><i class="glyphicon glyphicon-cog"></i> Settings</a></li>
            </ul>
            <!-- Tab panes -->
            <div class="tab-content">
                <div class="tab-pane active" id="editor-tab">
                    <div class="btn-toolbar" role="toolbar">
                        <div class="btn-group btn-group-sm">
                            <form class="form-inline" role="form">
                                <label class="sr-only" for="title_input">Document Title</label>
                                <input type="text" id="title_input" class="form-control input-sm" placeholder="Untitled Document" data-toggle="tooltip" title="保存するファイル名の指定" />
                            </form>
                        </div>
                    
                        <div class="btn-group btn-group-sm" data-toggle="tooltip" title="ファイルに保存">
                            <button id="download_btn" type="button" class="btn btn-primary" title="save" data-toggle="modal" data-target="#download-modal"><i class="glyphicon glyphicon-floppy-save"></i></button>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <!-- undo button -->
                            <button id="undo-btn" type="button" class="btn btn-default" data-toggle="tooltip" data-placement="top" title="元にもどす"><i class="glyphicon glyphicon-step-backward"></i></button>
                            <!-- redo button -->
                            <button id="redo-btn" type="button" class="btn btn-default" data-toggle="tooltip" data-placement="top" title="やり直す"><i class="glyphicon glyphicon-step-forward"></i></button>
                        </div>
                        <div class="btn-group btn-group-sm" data-toggle="tooltip" title="見出し">
                          <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown"><i class="glyphicon glyphicon-header"></i> <span class="caret"></span></button>
                          <ul class="dropdown-menu" role="menu">
                                <li><a class="h_btn" href="#" data-dd-hlank="1">h1</a></li>
                                <li><a class="h_btn" href="#" data-dd-hlank="2">h2</a></li>
                                <li><a class="h_btn" href="#" data-dd-hlank="3">h3</a></li>
                                <li><a class="h_btn" href="#" data-dd-hlank="4">h4</a></li>
                                <li><a class="h_btn" href="#" data-dd-hlank="5">h5</a></li>
                                <li><a class="h_btn" href="#" data-dd-hlank="6">h6</a></li>
                          </ul>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <!-- bold button -->
                            <button id="bold_btn" type="button" class="btn btn-default" data-toggle="tooltip" title="太字・重要なテキスト"><i class="glyphicon glyphicon-bold"></i></button>
                            <!-- italic button -->
                            <button id="italic_btn" type="button" class="btn btn-default" data-toggle="tooltip" title="斜体・強調するテキスト"><i class="glyphicon glyphicon-italic"></i></button>
                            <!-- ruby button -->
                            <button id="ruby_btn" type="button" class="btn btn-default" data-toggle="tooltip" title="ルビをふる">ruby</button>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <!-- link button -->
                            <button id="link_btn" type="button" class="btn btn-default" data-toggle="tooltip" title="リンクの挿入"><i class="glyphicon glyphicon-link"></i></button>
                            <!-- image button -->
                            <button id="image_btn" type="button" class="btn btn-default" data-toggle="tooltip" title="画像の挿入 （Dropboxアカウントが必要です）"><i class="glyphicon glyphicon-picture"></i></button>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <!-- remove button -->
                            <button id="remove_btn" type="button" class="btn btn-warning" data-toggle="tooltip" title="編集中のテキストの消去"><i class="glyphicon glyphicon-remove"></i></button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-9  col-xs-9">
                        <pre id="editor">&lt;div class="page-header" markdown="1"&gt;
# でんでんライブエディタ（仮）
&lt;/div&gt;

でんでんマークダウンをリアルタイムでプレビューできるよっ！

## 段落

これは段落です。

これは別の段落です。


### 段落内の改行

これは段落です。
これは段落の続きです。

---

## 見出し

# 見出しレベル１ #

## 見出しレベル２ ##

### 見出しレベル３ ###

#### 見出しレベル４ ####

##### 見出しレベル５ #####

###### 見出しレベル６ ######

---

## 引用

> これは引用された段落です。
>
> これも引用された段落です。

---

## リスト

* りんご
* もも
* みかん

1. りんご
2. もも
3. みかん

---

## コードブロック

    &lt;body&gt;
      &lt;p&gt;Hello world.&lt;/p&gt;
    &lt;/body&gt;

---

## ハイパーリンク

詳しくは[こちら](http://example.com/)をごらんください。

---

## 強調

これは*強調されたテキスト*です。

これは**重要なテキスト**です。

---

## ルビ

{電子出版|でんししゅっぱん}を手軽に

---

## 縦中横

昭和^53^年

---

## 脚注

これは脚注付き[^1]の段落です。

[^1]: そして、これが脚注です。

---

## 画像

![電書ちゃん](https://lh4.googleusercontent.com/-m3cvu_gKtW8/TrauQGoZbHI/AAAAAAAAJdc/ytImJ4o4DcU/s144/sd-07.png)
                        </pre>
                        </div>
                        <div class="col-md-3 col-xs-3">
                            <!-- componet snippets -->

                            <div class="btn-group-vertical" data-toggle="tooltip" title="スニペット（コード片）の挿入。カーソルの位置にスニペットを挿入します">
                                <button type="button" class="btn btn-default btn-sm dd-snippet-btn" data-dd-snippet-name="page-header">ページヘッダ</button>
                                <!-- Text -->
                                <div class="btn-group btn-group-sm">
                                  <button id="text_btn_drop" type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                                      テキスト
                                      <span class="caret"></span>
                                  </button>
                                  <ul class="dropdown-menu" role="menu" aria-labelledby="text_btn_drop">
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="lead">リード文</a></li>
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="text-left">左寄せ</a></li>
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="text-center">中央揃え</a></li>
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="text-right">右寄せ</a></li>
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="text-muted">色（ミュート・灰色）</a></li>
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="text-primary">色（プライマリ・青）</a></li>
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="text-success">色（成功・緑）</a></li>
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="text-info">色（情報・水色）</a></li>
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="text-warning">色（警告・黄色）</a></li>
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="text-danger">色（危険・赤）</a></li>
                                  </ul>
                                </div>
                                <div class="btn-group btn-group-sm">
                                  <button id="bq_btn_drop" type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                                      引用
                                      <span class="caret"></span>
                                  </button>
                                  <ul class="dropdown-menu" role="menu" aria-labelledby="bq_btn_drop">
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="blockquote--source">出典付き</a></li>
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="blockquote-reverse--source">出典付き 右寄せ</a></li>
                                  </ul>
                                </div>
                                <!-- Lists -->
                                <div class="btn-group btn-group-sm">
                                  <button id="list_btn_drop" type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                                      リスト（箇条書き）
                                      <span class="caret"></span>
                                  </button>
                                  <ul class="dropdown-menu" role="menu" aria-labelledby="list_btn_drop">
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="list-unstyled">マーカーなし</a></li>
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="list-inline">インライン</a></li>
                                  </ul>
                                </div>
                                <!-- Tables -->
                                <div class="btn-group btn-group-sm">
                                  <button id="table_group_btn_drop" type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                                      表
                                      <span class="caret"></span>
                                  </button>
                                  <ul class="dropdown-menu" role="menu" aria-labelledby="table_group_btn_drop">
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="table">通常</a></li>
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="table-condensed">狭め</a></li>
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="table-striped">ストライプ</a></li>
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="table-bordered">枠あり</a></li>
                                  </ul>
                                </div>
                                <!-- Labels -->
                                <div class="btn-group btn-group-sm">
                                  <button id="label_btn_drop" type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                                      ラベル
                                      <span class="caret"></span>
                                  </button>
                                  <ul class="dropdown-menu" role="menu" aria-labelledby="label_btn_drop">
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="label">通常</a></li>
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="label-primary">色（プライマリ・青）</a></li>
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="label-success">色（成功・緑）</a></li>
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="label-info">色（情報・水色）</a></li>
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="label-warning">色（警告・黄色）</a></li>
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="label-danger">色（危険・赤）</a></li>
                                  </ul>
                                </div>
                                <!-- Alerts -->
                                <div class="btn-group btn-group-sm">
                                  <button id="alerts_btn_drop" type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                                      注意書き
                                      <span class="caret"></span>
                                  </button>
                                  <ul class="dropdown-menu" role="menu" aria-labelledby="alerts_btn_drop">
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="alert-success">色（成功・緑）</a></li>
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="alert-info">色（情報・水色）</a></li>
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="alert-warning">色（警告・黄色）</a></li>
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="alert-danger">色（危険・赤）</a></li>
                                  </ul>
                                </div>
                                <!-- List Group -->
                                <div class="btn-group btn-group-sm">
                                  <button id="list_group_btn_drop" type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                                      リストグループ
                                      <span class="caret"></span>
                                  </button>
                                  <ul class="dropdown-menu" role="menu" aria-labelledby="list_group_btn_drop">
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="list-group">通常</a></li>
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="list-group--link">a タグ</a></li>
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="list-group--link--content">見出し付き</a></li>
                                  </ul>
                                </div>
                                <!-- Panels -->
                                <div class="btn-group btn-group-sm">
                                  <button id="panel_btn_drop" type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                                      パネル
                                      <span class="caret"></span>
                                  </button>
                                  <ul class="dropdown-menu" role="menu" aria-labelledby="panel_btn_drop">
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="panel">通常</a></li>
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="panel--title">ヘッダあり</a></li>
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="panel--footer">ヘッダ・見出しあり</a></li>
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="panel-primary">色（プライマリ・青）</a></li>
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="panel-success">色（成功・緑）</a></li>
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="panel-info">色（情報・水色）</a></li>
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="panel-warning">色（警告・黄色）</a></li>
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="panel-danger">色（危険・赤）</a></li>
                                  </ul>
                                </div>
                                <!-- Wells -->
                                <div class="btn-group btn-group-sm">
                                  <button id="well_btn_drop" type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                                      囲み
                                      <span class="caret"></span>
                                  </button>
                                  <ul class="dropdown-menu" role="menu" aria-labelledby="well_btn_drop">
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="well">通常</a></li>
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="well-lg">広め</a></li>
                                    <li><a href="#" class="dd-snippet-btn" data-dd-snippet-name="well-sm">狭め</a></li>
                                  </ul>
                                </div>

                                <p class="text-muted small"><strong>でんでんブックストラップ</strong> 用のスニペットを挿入します</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane" id="preview-tab">
                    <div class="btn-toolbar" role="toolbar">
                        <!--
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn" disabled="disabled"><i class="glyphicon glyphicon-refresh"></i></button>
                        </div>
                        -->
                        <div class="btn-group btn-group-sm" data-toggle="tooltip" title="表示するレイアウトを選択します">
                          <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown"><i class="glyphicon glyphicon-hand-right"></i> テーマを選んでね <span class="caret"></span></button>
                          <ul class="dropdown-menu" role="menu">
                                  <li><a id="theme_default" href="#">でんでんコンバーター横書きデフォルト</a></li>
                                  <li><a id="theme_default_vertical" href="#">でんでんコンバーター縦書きデフォルト</a></li>
                                  <li><a id="theme_bookstrap" href="#">でんでんブックストラップ（Bootstrap互換）</a></li>
                                  <li class="divider"></li>
                                  <li><a id="theme_plain" href="#">プレーン</a></li>
                          </ul>
                        </div>
                        <div class="btn-group btn-group-sm" data-toggle="tooltip" title="文字の大きさを変更します">
                          <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown"><i class="glyphicon glyphicon-font"></i> 文字の大きさ <span class="caret"></span></button>
                          <ul class="dropdown-menu" role="menu">
                            <li><a class="font_size_btn" data-dd-font-size="75" href="#">75%</a></li>
                            <li><a class="font_size_btn" data-dd-font-size="100" href="#">100%</a></li>
                            <li><a class="font_size_btn" data-dd-font-size="150" href="#">150%</a></li>
                          </ul>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <a id="kanji_btn" class="btn btn-default" href="#" data-toggle="tooltip" title="常用漢字に含まれない漢字の背景を水色に、人名用漢字の背景をピンク色にハイライトします"><i class="glyphicon glyphicon-check"></i> 常用漢字のチェック</a>
                        </div>
                    </div>
                    <div id="loading_image_container">
                        <img src="assets/images/ajax-loader.gif" alt="" />
                    </div>
                    <iframe id="preview" seamless="seamless"></iframe>
                </div>
                <div class="tab-pane" id="code-tab">
                    <div class="btn-toolbar" role="toolbar">
                        <div class="btn-group btn-group-sm">
                            <button id="select_all_btn" type="button" class="btn btn-default"  data-toggle="tooltip" title="HTMLのコードを全て選択状態にします"><i class="glyphicon glyphicon-paperclip"></i> コードを全て選択</button>
                        </div>
                    </div>
                    <textarea id="code" readonly="readonly"></textarea>
                </div>
                <!-- CSS tab -->
                <div class="tab-pane" id="css-tab">
                    <div class="btn-toolbar" role="toolbar">
                        <div class="btn-group btn-group-sm">
                            <!-- remove button -->
                            <button id="css_remove_btn" type="button" class="btn btn-warning"  data-toggle="tooltip" title="編集中のテキストの消去"><i class="glyphicon glyphicon-remove"></i></button>
                        </div>
                    </div>
                    <pre id="css_editor">/* 独自に追加したいCSSがあればここに書いてください。プレビューに反映されます  */
</pre>
                </div>
                <!-- Settings tab -->
                <div class="tab-pane" id="settings-tab">
                    <div id="settings-tab__container">
                      <div class="row">
                      <div class="col-md-5 col-md-offset-2">
                      <form role="form">
                        <h3>Markdown Mode</h3>
                        <div class="radio">
                          <label>
                            <input class="markdown_mode_btn" type="radio" name="optionsRadios" id="markdown_btn--denden" value="denden" checked />
                            でんでんマークダウン
                          </label>
                        </div>
                        <div class="radio">
                          <label>
                            <input class="markdown_mode_btn" type="radio" name="optionsRadios" id="markdown_btn--extra" value="extra" />
                            Markdown Extra
                          </label>
                        </div>
                        <div class="radio">
                          <label>
                            <input class="markdown_mode_btn" type="radio" name="optionsRadios" id="markdown_btn--plain" value="markdown" />
                            Markdown
                          </label>
                        </div>
                        <span class="help-block">Markdownの変換モードを選択します</span>
                      </form>
                      </div> 
                      </div>
                      <hr />           
                    </div>
                </div>
                
            </div>
            <hr />
            <div class="alert alert-warning">
            <strong>注意</strong>  開発中のものなのでこっそり使ってください。拡散禁止です。
            </div>
        </div>
        </div>

        <div class="modal fade" id="download-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">ファイルのダウンロード</h4>
              </div>
              <div class="modal-body">
                <dl>
                    <dt>ファイル名</dt>
                    <dd id="download_filename"></dd>
                </dl>
                <hr />
                <ul class="list-inline">
                  <li><a id="download-link" class="btn btn-primary" href="#">Download</a></li>
                  <li><span id="dropbox-saver-container"></span><li>
                </ul>
              </div>
            </div><!-- /.modal-content -->
          </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->
        
        <footer id="footer">
            <div class="container">
                <p class="text-muted"><small>Copyright © 2014 <a href="http://densho.hatenablog.com">電書ちゃんねる</a></small></p>
            </div>
        </footer>
        <!-- js -->
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
        <script src="ace/src-min-noconflict/ace.js" ></script>
        <script src="http://netdna.bootstrapcdn.com/bootstrap/3.1.0/js/bootstrap.min.js"></script>
        <script type="text/javascript">
            var ns = {} || ns;
        
            $(function () {
                ns.config = {}
                ns.config.request_uri = "http://denden-api-md-tmp.herokuapp.com/markdown";
                ns.config.request_method = "POST";
                ns.config.request_mode = "denden";

                // editor setup
                ns.editor = ace.edit("editor");
                ns.editor.setTheme("ace/theme/github");
                ns.editor.getSession().setMode("ace/mode/markdown");
                ns.editor.getSession().setUseWrapMode(true);
                ace.config.loadModule('ace/ext/language_tools', function () {
                    ns.editor.setOptions({
                        enableBasicAutocompletion: true,
                        enableSnippets: true
                    })
                    ns.snippetManager = ace.require("ace/snippets").snippetManager;
                    var config = ace.require("ace/config");
        
                    ace.config.loadModule("ace/snippets/markdown", function (m) {
                        if (m) {
                            ns.snippetManager.files.javascript = m;
                            m.snippets = ns.snippetManager.parseSnippetFile(m.snippetText);
        
                            // or do this if you already have them parsed
                            m.snippets.push({
                                content: "{${1:親文字}|${2:ルビ文字}}",
                                name: "ruby",
                                tabTrigger: "{"
                            });
                            m.snippets.push({
                                content: "^${1:縦中横にする文字}^",
                                name: "tcy",
                                tabTrigger: "^"
                            });
                            ns.snippetManager.register(m.snippets, m.scope);
                        }
                    });
                    // Load bootstrap snippets
                    ace.config.loadModule("ace/snippets/bookstrap-ja", function (m) {
                        if (m) {
                            ns.snippetManager.files.markdown = m;
                            m.snippets = ns.snippetManager.parseSnippetFile(m.snippetText);
                            ns.snippetManager.register(m.snippets, m.scope);
                        }
                    });
                });

                // css editor setup
                ns.css_editor = ace.edit("css_editor");
                ns.css_editor.setTheme("ace/theme/github");
                ns.css_editor.getSession().setMode("ace/mode/css");
                ns.css_editor.getSession().setUseWrapMode(true);
                ns.css_editor.gotoLine(2, 0, false);

                ns.loadPreviousData = function() {
                  var previous_data = localStorage.getItem("previous_data");

                  if(previous_data) {
                    if (confirm("前回の編集データを読み込みますか？")) {
                        var p = JSON.parse(previous_data);
                        ns.editor.setValue(p.text);
                        ns.css_editor.setValue(p.custom_css);
                    }
                  }
                }

                ns.preview = document.getElementById('preview');
                ns.target_doc = ns.preview.contentDocument;
                ns.code = document.getElementById('code');

                ns.initDoc = function() {
                   ns.target_doc.documentElement.innerHTML = '<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops"><head id="head"><link id="css_link" rel="stylesheet" href="./default.css" /><link id="custom_css_link" rel="stylesheet" href="./plain.css" /></head><body></body></html>';
                  ns.target_doc_head = ns.target_doc.getElementById('head');
                  ns.target_doc_css_link = ns.target_doc.getElementById('css_link');
                  ns.target_doc_custom_css_link = ns.target_doc.getElementById('custom_css_link');
                  ns.target_doc_body = ns.target_doc.getElementsByTagName('body')[0];
                };

                ns.initDoc();

                ns.render = function(){
                    var XHR = new XMLHttpRequest();
                    XHR.open(ns.config.request_method, ns.config.request_uri);
                    XHR.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                    XHR.send(JSON.stringify({
                        "text": ns.editor.getValue(),
                        "mode": ns.config.request_mode
                    }));
                    $('#preview').attr('style', 'visibility:hidden;');
                    $('#loading_image_container').fadeIn();
                    XHR.onload = function () {
                        var text = XHR.responseText;
                        ns.code.textContent = text;
                        ns.target_doc.getElementsByTagName('body')[0].innerHTML = text;
                        $('#loading_image_container').fadeOut();
                        $('#preview').attr('style', 'visibility:visible');
                    }
                }

                ns.render();

                ns.applyCustomCSS = function(){
                    var css_val = ns.css_editor.getValue();
                    var data = encodeURIComponent(css_val);
                    var data = 'data:text/css,' + data;
                    ns.target_doc_custom_css_link.setAttribute('href', data);
                }
        
                // build snippet buttons
                $("#undo-btn").click(function () {
                    ns.editor.undo();
                });
                $("#redo-btn").click(function () {
                    ns.editor.redo();
                });
                $('#bold_btn').click(function () {
                    var selection = ns.editor.session.getTextRange(ns.editor.getSelectionRange());
                    if (selection == "") {
                        selection = "重要なテキスト"
                    }
                    var snippet = "**${1:" + selection + "}**";
                    ns.snippetManager.insertSnippet(ns.editor, snippet);
                    ns.editor.focus();
                });
                $('#italic_btn').click(function () {
                    var selection = ns.editor.session.getTextRange(ns.editor.getSelectionRange());
                    if (selection == "") {
                        selection = "強調されたテキスト"
                    }
                    var snippet = "*${1:" + selection + "}*";
                    ns.snippetManager.insertSnippet(ns.editor, snippet);
                    ns.editor.focus();
                });
                $('#ruby_btn').click(function () {
                    var selection = ns.editor.session.getTextRange(ns.editor.getSelectionRange());
                    if (selection == "") {
                        selection = "親文字";
                        var snippet = "{${1:" + selection + "}|${2:ルビ文字}}";
                    } else {
                        var snippet = "{" + selection + "|${1:ルビ文字}}";
                    }
                    ns.snippetManager.insertSnippet(ns.editor, snippet);
                    ns.editor.focus();
                });
                $('#link_btn').click(function () {
                    var selection = ns.editor.session.getTextRange(ns.editor.getSelectionRange());
                    if (selection == "") {
                        selection = "代替テキスト";
                        var snippet = "[${1:" + selection + "}](${2:http://example.com})";
                    } else {
                        var snippet = "[" + selection + "](${1:http://example.com})";
                    }
                    ns.snippetManager.insertSnippet(ns.editor, snippet);
                    ns.editor.focus();
                });
                $('#image_btn').click(function () {
                  var options = {
                    success: function(files) {
                      var link = files[0]['link'];
                      var snippet = "![${1:代替テキスト}](" + link +")";
                      ns.snippetManager.insertSnippet(ns.editor, snippet);
                      ns.editor.focus();
                    },
                    linkType: "direct", 
                    multiselect: false,
                    extensions: ['.jpg', '.jpeg', '.JPG', '.JPEG', '.png', '.PNG', '.gif', '.GIF', '.svg'],
                  };
                  var link = Dropbox.choose(options);
                  console.log(link)

                });
                $(".h_btn").click(function () {
                    var selection = ns.editor.session.getTextRange(ns.editor.getSelectionRange());
                    if (selection == "") {
                        selection = "見出し";
                    }
                    var lank = parseInt(this.getAttribute('data-dd-hlank'));
                    var hmark = "";
                    for (i = 0; i < lank; i = i + 1) {
                        hmark += "#";
                    }
                    var snippet = hmark + " ${1:" + selection + "} " + hmark;
                    ns.snippetManager.insertSnippet(ns.editor, snippet);
                    ns.editor.focus();
                });
                $('.dd-snippet-btn').click(function () {
                    var snippetName = this.getAttribute('data-dd-snippet-name');
                    var s = ns.snippetManager.getSnippetByName(snippetName, ns.editor);
                    ns.snippetManager.insertSnippet(ns.editor, s.content);
                    ns.editor.focus();
                });
                $('.font_size_btn').click(function(){
                  var size = this.getAttribute('data-dd-font-size');
                  ns.target_doc_body.setAttribute('style', 'font-size:' + size + "%;");
                });
        
                $('#preview-link, #code-link').on('shown.bs.tab', function (e) {
                    ns.render();
                    ns.applyCustomCSS();
                });

                ns.setPreviewTheme = function(name) {
                    if (name == 'plain') {
                        ns.target_doc_css_link.setAttribute('href', './plain.css');
                    } else if (name == 'bookstrap') {
                        ns.target_doc_css_link.setAttribute('href', 'http://denshoch.github.io/bookstrap/build/stylesheets/bookstrap.css');
                    } else if (name == 'default') {
                        ns.target_doc_css_link.setAttribute('href', './default.css');
                    } else if (name == 'default_vertical') {
                        ns.target_doc_css_link.setAttribute('href', './default_vertical.css');
                    } else {
                        ns.target_doc_css_link.setAttribute('href', './plain.css');
                    }
                }

                $("#theme_plain").click(function () {
                    ns.setPreviewTheme('plain');
                });
        
                $("#theme_bookstrap").click(function () {
                    ns.setPreviewTheme('bookstrap');
                });
        
                $("#theme_default").click(function () {
                    ns.setPreviewTheme('default');
                });
        
                $("#theme_default_vertical").click(function () {
                    ns.setPreviewTheme('default_vertical');
                });
        
                $("#kanji_btn").click(function () {
                    checkKanji(ns.target_doc_body);
                });
        
                $("#select_all_btn").click(function () {
                    $('#code').select();
                });
        
                $("#select_all_css_btn").click(function () {
                    $('#css_code').select();
                });
        
                $('#download-modal').on('show.bs.modal', function (e) {
                    var container = document.getElementById('dropbox-saver-container');
                    // remove previous Dropbox Saver button
                    for(var i = container.childNodes.length - 1; i >= 0; i--) {
                      container.removeChild(container.childNodes[i]);
                    }
                    
                    var title = $('#title_input').val();
                    if (!title) {
                        title = "Untitled Document"
                    }

                    var filename = title.replace(/\s+|　+/g, '_') + '.txt';
                    $('#download_filename').text(filename);
                    console.log(filename);

                    var text = ns.editor.getValue();

                    // create Dropbox Saver button
                    var data = window.btoa(unescape(encodeURIComponent(text)));
                    var options = {
                      files: [
                        {'url': 'data:text/plain;base64,' + data, 'filename': filename}
                      ],
                      error: function (errorMessage) {
                        console.log(errorMessage);
                      }
                    };
                    var button = Dropbox.createSaveButton(options);
                    container.appendChild(button);

                    // set blob to href
                    var blob = new Blob([text], {
                        "type": "text/plain"
                    });
                    $('#download-link').attr('href', window.URL.createObjectURL(blob));
                    $('#download-link').attr('download', filename);
                });

                $('.markdown_mode_btn').change(function(){
                    var v = $(this).attr('value');
                    console.log(v);
                    ns.config.request_mode = v;
                    console.log(ns.config.request_mode);
                });
                $(window).bind("beforeunload", function() {
                  var obj = {
                    text: ns.editor.getValue(),
                    custom_css: ns.css_editor.getValue()
                  }
                  localStorage.setItem("previous_data", JSON.stringify(obj));
                });

                $("#remove_btn").click(function () {
                    if (confirm("編集中のテキストを消去します。よろしいですか？")) {
                        ns.editor.setValue("", -1);
                    }
                });
                $("#css_remove_btn").click(function () {
                    if (confirm("編集中のテキストを消去します。よろしいですか？")) {
                        ns.css_editor.setValue("", -1);
                    }
                });

                // Initialize Bootstrap tooltip
                $("[data-toggle=tooltip]").tooltip({"container": 'body'});

                ns.loadPreviousData();

            });

        </script>
    </body>
</html>
