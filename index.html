<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">
    <head>
        <meta charset="utf-8" />
        <title>でんでんライブエディタ</title>
        <script type="text/javascript" src="http://denshoch.github.io/mojimate.js/mojimate.js"></script>
        <link href="http://netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css" rel="stylesheet" />
        <link href="assets/stylesheets/style.css" rel="stylesheet" />
        <link href="" rel="stylesheet" />
    </head>
    <body>
        <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="navbar-header">
                <a class="navbar-brand" href="#">でんでんライブエディタ（仮）</a>
            </div>
  <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
    <ul class="nav navbar-nav">
      <li><a href="http://conv.denshochan.com/">でんでんコンバーター</a></li>
      <li><a href="http://conv.denshochan.com/markdown">でんでんマークダウン</a></li>
    </ul>
  </div>
        </nav>
        
        <div id="wrap">
         <div class="container">
            <ul class="nav nav-tabs">
                <li><a id="editor-link" href="#editor-tab" data-toggle="tab"><i class="glyphicon glyphicon-pencil"></i> Edit</a></li>
                <li><a id="preview-link" href="#preview-tab" data-toggle="tab"><i class="glyphicon glyphicon-eye-open"></i> Preview</a></li>
                <li><a id="code-link" href="#code-tab" data-toggle="tab"><i class="glyphicon glyphicon-list-alt"></i> Code</a></li>
                <li><a id="css-editor-link" href="#css-tab" data-toggle="tab"><i class="glyphicon glyphicon-asterisk"></i> Custom CSS</a></li>
            </ul>
            <!-- Tab panes -->
            <div class="tab-content">
                <div class="tab-pane active" id="editor-tab">
                    <div class="btn-toolbar" role="toolbar">
                    
                        <div class="btn-group btn-group-sm">
                            <form class="form-inline" role="form">
                                <label class="sr-only" for="title_input">Document Title</label>
                                <input type="text" id="title_input" class="form-control input-sm" placeholder="Untitled Document" />
                            </form>
                        </div>
                    
                        <div class="btn-group btn-group-sm">
                            <button id="download_btn" type="button" class="btn btn-primary" title="save" data-toggle="modal" data-target="#download-modal"><i class="glyphicon glyphicon-floppy-save"></i></button>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <!-- undo button -->
                            <button id="undo-btn" type="button" class="btn btn-default" title="undo"><i class="glyphicon glyphicon-step-backward"></i></button>
                            <!-- redo button -->
                            <button id="redo-btn" type="button" class="btn btn-default" title="redo"><i class="glyphicon glyphicon-step-forward"></i></button>
                        </div>
                        <div class="btn-group btn-group-sm">
                          <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown"><i class="glyphicon glyphicon-header"></i> <span class="caret"></span></button>
                          <ul class="dropdown-menu" role="menu">
                                <li><a class="h_btn" href="#" data-dd-hlank="1">h1</a></li>
                                <li><a class="h_btn" href="#" data-dd-hlank="2">h2</a></li>
                                <li><a class="h_btn" href="#" data-dd-hlank="3">h3</a></li>
                                <li><a class="h_btn" href="#" data-dd-hlank="4">h4</a></li>
                                <li><a class="h_btn" href="#" data-dd-hlank="5">h5</a></li>
                                <li><a class="h_btn" href="#" data-dd-hlank="6">h6</a></li>
                          </ul>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <!-- bold button -->
                            <button id="bold_btn" type="button" class="btn btn-default"><i class="glyphicon glyphicon-bold"></i></button>
                            <!-- italic button -->
                            <button id="italic_btn" type="button" class="btn btn-default"><i class="glyphicon glyphicon-italic"></i></button>
                            <!-- ruby button -->
                            <button id="ruby_btn" type="button" class="btn btn-default">ruby</button>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <!-- link button -->
                            <button id="link_btn" type="button" class="btn btn-default"><i class="glyphicon glyphicon-link"></i></button>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <!-- remove button -->
                            <button id="remove_btn" type="button" class="btn btn-warning" title="remove"><i class="glyphicon glyphicon-remove"></i></button>
                        </div>
                        <div class="btn-group btn-group-sm pull-right">
                            <a class="btn btn-default" href="http://conv.denshochan.com/markdown" target="_blank"><i class="glyphicon glyphicon-new-window"></i> でんでんマークダウンのヘルプ</a>
                        </div>
                    </div>
                    <pre id="editor">&lt;div class="page-header" markdown="1"&gt;
# でんでんライブエディタ（仮）
&lt;/div&gt;

でんでんマークダウンをリアルタイムでプレビューできるよっ！

## 段落

これは段落です。

これは別の段落です。


### 段落内の改行

これは段落です。
これは段落の続きです。

---

## 見出し

# 見出しレベル１ #

## 見出しレベル２ ##

### 見出しレベル３ ###

#### 見出しレベル４ ####

##### 見出しレベル５ #####

###### 見出しレベル６ ######

---

## 引用

> これは引用された段落です。
>
> これも引用された段落です。

---

## リスト

* りんご
* もも
* みかん

1. りんご
2. もも
3. みかん

---

## コードブロック

    &lt;body&gt;
      &lt;p&gt;Hello world.&lt;/p&gt;
    &lt;/body&gt;

---

## ハイパーリンク

詳しくは[こちら](http://example.com/)をごらんください。

---

## 強調

これは*強調されたテキスト*です。

これは**重要なテキスト**です。

---

## ルビ

{電子出版|でんししゅっぱん}を手軽に

---

## 縦中横

昭和^53^年

---

## 脚注

これは脚注付き[^1]の段落です。

[^1]: そして、これが脚注です。

---

## 画像

![電書ちゃん](https://lh4.googleusercontent.com/-m3cvu_gKtW8/TrauQGoZbHI/AAAAAAAAJdc/ytImJ4o4DcU/s144/sd-07.png)
                    </pre>
                </div>
                <div class="tab-pane" id="preview-tab">
                    <div class="btn-toolbar" role="toolbar">
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn" disabled="disabled"><i class="glyphicon glyphicon-refresh"></i></button>
                        </div>
                        <div class="btn-group btn-group-sm">
                          <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown"><i class="glyphicon glyphicon-hand-right"></i> テーマを選んでね <span class="caret"></span></button>
                          <ul class="dropdown-menu" role="menu">
                                  <li><a id="theme_default" href="#">でんでんコンバーター横書きデフォルト</a></li>
                                  <li><a id="theme_default_vertical" href="#">でんでんコンバーター縦書きデフォルト</a></li>
                                  <li><a id="theme_bookstrap" href="#">でんでんブックストラップ（Bootstrap互換）</a></li>
                                  <li class="divider"></li>
                                  <li><a id="theme_plain" href="#">プレーン</a></li>
                          </ul>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <a id="kanji_btn" class="btn btn-default" href="#"><i class="glyphicon glyphicon-check"></i> 常用漢字のチェック</a>
                        </div>
                    </div>
                    <iframe id="preview" seamless="seamless"></iframe>
                </div>
                <div class="tab-pane" id="code-tab">
                    <div class="btn-toolbar" role="toolbar">
                        <div class="btn-group btn-group-sm">
                            <button id="select_all_btn" type="button" class="btn btn-default"><i class="glyphicon glyphicon-paperclip"></i> コードを全て選択</button>
                        </div>
                    </div>
                    <textarea id="code" readonly="readonly"></textarea>
                </div>
                <div class="tab-pane" id="css-tab">
                    <div class="btn-toolbar" role="toolbar">
                        <div class="btn-group btn-group-sm">
                            <button id="select_all_css_btn" type="button" class="btn btn-default"><i class="glyphicon glyphicon-paperclip"></i> コードを全て選択</button>
                        </div>
                    </div>
                    <textarea id="css_code">/* 独自に追加したいCSSがあればここに書いてください。プレビューに反映されます  */</textarea>
                </div>
            </div>
            <hr />
            <div class="alert alert-warning">
            <strong>注意</strong>  開発中のものなのでこっそり使ってください。拡散禁止です。
            </div>
        </div>
        </div>

        <div class="modal fade" id="download-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">ファイルのダウンロード</h4>
              </div>
              <div class="modal-body">
                <dl>
                    <dt>ファイル名</dt>
                    <dd id="download_filename"></dd>
                </dl>
                <a id="download-link" class="btn btn-primary" href="#">Download</a>
              </div>
            </div><!-- /.modal-content -->
          </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->
        
        <footer id="footer">
            <div class="container">
                <p class="text-muted"><small>Copyright © 2013 <a href="http://densho.hatenablog.com">電書ちゃんねる</a></small></p>
            </div>
        </footer>
        <!-- js -->
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
        <script src="ace/src-min-noconflict/ace.js" ></script>
        <script src="http://netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>
        <script type="text/javascript">
        $(function(){
            var editor = ace.edit("editor");
            editor.setTheme("ace/theme/github");
            editor.getSession().setMode("ace/mode/markdown");
            editor.getSession().setUseWrapMode(true);
            ace.config.loadModule('ace/ext/language_tools', function () {
                editor.setOptions({
                    enableBasicAutocompletion: true,
                    enableSnippets: true
                })
                
                var snippetManager = ace.require("ace/snippets").snippetManager;

                var config = ace.require("ace/config");
        
                ace.config.loadModule("ace/snippets/markdown", function(m) {
                if (m) {
                  snippetManager.files.javascript = m;          
                  m.snippets = snippetManager.parseSnippetFile(m.snippetText);
                  
                  // or do this if you already have them parsed
                  m.snippets.push({
                    content: "{${1:親文字}|${2:ルビ文字}}",
                    name: "ruby",
                    tabTrigger: "{"
                  });
                  m.snippets.push({
                    content: "^${1:縦中横にする文字}^",
                    name: "tcy",
                    tabTrigger: "^"
                  });
                  snippetManager.register(m.snippets, m.scope);
                  }
                });
                ace.config.loadModule("ace/snippets/bootstrap", function(m) {
                if (m) {
                  snippetManager.files.javascript = m;          
                  m.snippets = snippetManager.parseSnippetFile(m.snippetText);
                  
                  snippetManager.register(m.snippets, m.scope);
                  }
                });


            });

            var preview = document.getElementById('preview');
            var preview_doc = preview.contentDocument.documentElement;
            preview_doc.innerHTML = '<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops"><head id="head"><link id="css_link" rel="stylesheet" href="./default.css" /><link id="custom_css_link" rel="stylesheet" href="./plain.css" /></head><body id="body" style="-webkit-transform-origin: 50% 0% 0;-moz-transform-origin: 50% 0% 0;-ms-transform-origin: 50% 0% 0;transform-origin: 50% 0% 0;-webkit-transform: scale(0.9);-moz-transform: scale(0.9);-ms-transform: scale(0.9);transform: scale(0.9);"></body></html>';
            var preview_doc_head = preview.contentDocument.getElementById('head');
            var preview_doc_css_link = preview.contentDocument.getElementById('css_link');
            var preview_doc_custom_css_link = preview.contentDocument.getElementById('custom_css_link');
            var preview_doc_body = preview.contentDocument.getElementById('body');

            var code = document.getElementById('code');

            // build snippet buttons
            

            $("#undo-btn").click(function(){
                editor.undo();
            });
            $("#redo-btn").click(function(){
                editor.redo();
            });
            $('#bold_btn').click(function(){
                var snippetManager = ace.require("ace/snippets").snippetManager;
                var selection = editor.session.getTextRange(editor.getSelectionRange());
                if(selection == ""){selection = "重要なテキスト"}
                var snippet = "**${1:" + selection + "}**";
                snippetManager.insertSnippet(editor, snippet);
                editor.focus();
            });
            $('#italic_btn').click(function(){
                var snippetManager = ace.require("ace/snippets").snippetManager;
                var selection = editor.session.getTextRange(editor.getSelectionRange());
                if(selection == ""){selection = "強調されたテキスト"}
                var snippet = "*${1:" + selection + "}*";
                snippetManager.insertSnippet(editor, snippet);
                editor.focus();
            });
            $('#ruby_btn').click(function(){
                var snippetManager = ace.require("ace/snippets").snippetManager;
                var selection = editor.session.getTextRange(editor.getSelectionRange());
                if(selection == ""){
                    selection = "親文字";
                    var snippet = "{${1:" + selection + "}|${2:ルビ文字}}";
                } else {
                    var snippet = "{" + selection + "|${1:ルビ文字}}";
                }
                snippetManager.insertSnippet(editor, snippet);
                editor.focus();
            });
            $('#link_btn').click(function(){
                var snippetManager = ace.require("ace/snippets").snippetManager;
                var selection = editor.session.getTextRange(editor.getSelectionRange());
                if(selection == ""){
                    selection = "代替テキスト";
                    var snippet = "[${1:" + selection + "}](${2:http://example.com})";
                } else {
                    var snippet = "[" + selection + "](${1:http://example.com})";
                }
                snippetManager.insertSnippet(editor, snippet);
                editor.focus();
            });
            $(".h_btn").click(function(){
                var snippetManager = ace.require("ace/snippets").snippetManager;
                var selection = editor.session.getTextRange(editor.getSelectionRange());
                if(selection == ""){
                    selection = "見出し";
                }
                var lank = parseInt(this.getAttribute('data-dd-hlank'));
                var hmark = "";
                for(i=0; i<lank; i=i+1) {
                    hmark += "#";
                }
                var snippet = hmark + " ${1:" + selection + "} " + hmark;
                snippetManager.insertSnippet(editor, snippet);
                editor.focus();
            });

            function render() {
              var input = editor.getValue();
              var XHR = new XMLHttpRequest();
              XHR.open("POST", "http://denden-api-md-tmp.herokuapp.com/markdown");
              XHR.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
              XHR.send(JSON.stringify({"text": input, "mode": "denden"}));
              XHR.onload = function(){
                var text = XHR.responseText;
                code.textContent = text;
                preview_doc_body.innerHTML = text;
              }
            }

            render();

            $('#preview-link, #code-link').on('shown.bs.tab', function (e) {
                render();
                applyCustomCSS();
            });

            function set_preview_theme(theme) {
                if (theme == 'plain') {
                  preview_doc_css_link.setAttribute('href', './plain.css');
                } else if (theme == 'bookstrap') {
                  preview_doc_css_link.setAttribute('href', 'http://denshoch.github.io/bookstrap/build/stylesheets/bookstrap.css');
                } else if (theme == 'default') {
                  preview_doc_css_link.setAttribute('href', './default.css');
                } else if (theme == 'default_vertical') {
                  preview_doc_css_link.setAttribute('href', './default_vertical.css');
                } else {
                  preview_doc_css_link.setAttribute('href', './plain.css');
                }
            }

            $("#theme_plain").click(function(){
                set_preview_theme('plain');
            });

            $("#theme_bookstrap").click(function(){
                set_preview_theme('bookstrap');
            });

            $("#theme_default").click(function(){
                set_preview_theme('default');
            });

            $("#theme_default_vertical").click(function(){
                set_preview_theme('default_vertical');
            });

            $("#kanji_btn").click(function(){
                checkKanji(preview_doc_body);
            });

            $("#remove_btn").click(function(){
                if( confirm("編集中のテキストを消去します。よろしいですか？") ) {
                    editor.setValue("", -1)
                }
            });

            $("#select_all_btn").click(function(){
                $('#code').select();
            });

            $("#select_all_css_btn").click(function(){
                $('#css_code').select();
            });

            $('#download-modal').on('show.bs.modal', function (e) {
                var title = $('#title_input').val();
                if (!title) {
                    title = "Untitled Document"
                }

                var filename = title.replace(/\s+|　+/g,'_') + '.txt';
                $('#download_filename').text(filename);
                console.log(filename);
                var text = editor.getValue();
                var blob = new Blob([text],{"type" : "text/plain"});
                var download_link = document.getElementById('download-link');
                download_link.setAttribute("href", window.URL.createObjectURL(blob));
                download_link.setAttribute("download", filename);
            });

            function applyCustomCSS(){
                var css_val = $('#css_code').val();
                var data = encodeURIComponent(css_val);
                var data = 'data:text/css,' + data;
                preview_doc_custom_css_link.setAttribute('href', data);
            }
        });    
            
        </script>
    </body>
</html>
